

from absl.testing import absltest
from absl.testing import parameterized
from hemul import HEMul
import jax.numpy as jnp
import numpy as np
import util
import key_gen as kg
import ckks_ctx

testing_params = [{'testcase_name': '0'}]
@parameterized.named_parameters(testing_params)
class HEMulTest(parameterized.TestCase):
  def setUp(self):
    self.degree = 16
    self.num_slots = 8
    self.scalingFactor = 563019763943521

    self.q_towers = [1073742881, 1073742721, 1073741441, 1073741857, 524353]
    self.p_towers = [1073740609, 1073739937, 1073739649]
    self.q = 696985728458547852910430465530901300664961
    self.qt = 1329229981441028949792278227703286337
    self.p = 30
    self.CKKS_M_FACTOR = 1
    self.noise_scale_degree = 1
    self.max_bits_in_word = 61
    self.output_scale = (self.scalingFactor/self.q_towers[-1])**2
    self.sigma = 3.190000057220458984375
    key_pair = kg.gen_pke_pair(self.q_towers, self.p_towers, self.degree)
    self.ek = kg.gen_evaluation_key(key_pair["secret_key"], q=self.q_towers, P=self.p_towers, noise_std=self.sigma, noise_scale=1, dnum=3)
    self.params = {
        "degree": self.degree,
        "num_slots": self.num_slots,
        "scalingFactor": self.scalingFactor,
        "output_scale": self.output_scale,
        "q_towers": self.q_towers,
        "p_towers": self.p_towers,
        "p": self.p,
        "CKKS_M_FACTOR": self.CKKS_M_FACTOR,
        "max_bits_in_word": self.max_bits_in_word,
        "noise_scale_degree": self.noise_scale_degree,
        "public_key": key_pair["public_key"],
        "secret_key": key_pair["secret_key"]
    }
    self.real_values_input_in1 = [
        complex(0.25, 0), complex(0.5, 0), complex(0.75, 0), complex(1, 0),
        complex(2, 0), complex(3, 0), complex(4, 0), complex(5, 0),
    ]
    self.real_values_input_in2 = [
        complex(5, 0), complex(4, 0), complex(3, 0), complex(2, 0),
        complex(1, 0), complex(0.75, 0), complex(0.5, 0), complex(0.25, 0),
    ]
    self.real_values_multiply_result = [
        complex(1.25, 0), complex(2, 0), complex(2.25, 0), complex(2, 0),
        complex(2, 0), complex(2.25, 0), complex(2, 0), complex(1.25, 0),
    ]
    self.real_values_rotate_result = [
        complex(0.5, 0), complex(0.75, 0), complex(1, 0), complex(2, 0),
        complex(3, 0), complex(4, 0), complex(5, 0), complex(0.25, 0),
    ]

  # @absltest.skip("test a single experiment")
  def test_ckks_context_encrypt_multiply_decrypt_debug(self):
    """Debug purpose"""
    # Debug Input Fixed Value and Reference Value
    debug=True
    # Key Gen are using (moduli, degree) layout
    secret_key=[[759724850, 414566487, 355132464, 957632252, 310208444, 446317944, 209107621, 371574442, 86720461, 382538591, 618930722, 475623085, 235514188, 447023994, 403500295, 1042084311], [59403087, 434205543, 729007887, 376779143, 147059109, 532218161, 146010268, 596016426, 522415111, 944312398, 260946269, 396967349, 826129467, 47209693, 106898720, 316877679], [153878711, 325547957, 159485916, 104152713, 831203728, 907031373, 47492181, 158042799, 609462478, 995857792, 1002460355, 289053781, 601842641, 649088110, 668135824, 13453712], [583339367, 726021614, 251596946, 175718823, 35998486, 738458956, 853850647, 414452610, 694534092, 847893648, 900169408, 188398442, 1041582422, 398603785, 622840015, 116475579], [309914, 239339, 186531, 181620, 483568, 358879, 342466, 73037, 7061, 415470, 144041, 94542, 128417, 340962, 105311, 259297]]
    public_key=[[[690672306, 830745223, 545304921, 645095677, 308217035, 584823252, 867509825, 346289480, 344251223, 862690627, 60332571, 402818554, 937446664, 584749933, 933899185, 625672727], [269613625, 76983033, 185479728, 628827726, 592709543, 898127696, 1056937587, 819646184, 657933538, 630388137, 130320230, 659669976, 782866110, 442120972, 218530691, 1059507401], [212715492, 734183010, 532911244, 353066019, 478810208, 357768117, 1057076655, 585425989, 91383676, 180139006, 84568434, 680468486, 607031605, 741297801, 950503716, 44141057], [91407250, 415475867, 243226069, 896401960, 715981223, 339934704, 610180354, 835390301, 714019222, 605134499, 692680629, 765877160, 411696915, 748057474, 710921809, 56484676], [202429, 162257, 157258, 217315, 365242, 449221, 6607, 294898, 373296, 102816, 215596, 246789, 122713, 100820, 511533, 30490], [224662448, 1013927275, 298967722, 267576537, 791931673, 242249347, 1008566938, 1035543997, 715707176, 691055594, 15814749, 1001019112, 375818060, 959961326, 1030936195, 984502304], [574124002, 123091231, 40482595, 471673249, 851435242, 544216472, 726888992, 111811945, 947365639, 131332228, 102150717, 130968465, 92183566, 1053516139, 623373194, 585542313], [800402448, 737810832, 413587234, 975124013, 248923548, 924423228, 116963270, 820165305, 593759211, 992288576, 773761950, 515746022, 386838202, 105636232, 403398714, 78866529]], [[319748116, 269571339, 1033142537, 660850140, 35149269, 723633544, 539266989, 481271689, 50280859, 601609527, 414791144, 683891686, 323185651, 265780192, 685446731, 978039209], [47987382, 491961751, 709086901, 203723616, 721423432, 986035046, 687959460, 45802355, 794096370, 374191278, 5639384, 759061508, 298373731, 340926933, 338214275, 762343888], [315720279, 150570969, 355841338, 35555381, 334404163, 480925348, 956857357, 169188045, 593449474, 318270649, 673564583, 561178042, 802263701, 425880094, 273871873, 515145407], [641543720, 637686978, 310954655, 862941784, 997906543, 877515331, 204240516, 22376974, 1017899162, 574931099, 971428840, 1015030583, 867816474, 210721452, 933053609, 659146450], [191480, 205801, 360613, 62411, 65882, 194303, 274117, 475602, 468073, 142595, 154547, 236074, 125209, 307107, 162077, 345752], [517483364, 632463757, 369687074, 1073000184, 1022129624, 677407060, 934316009, 1062792519, 577320277, 494481587, 724823316, 497722122, 390368121, 247708979, 619071326, 125818230], [311110192, 426799490, 377162591, 763058495, 647168016, 801888391, 443579364, 751296233, 429453275, 443686934, 139676085, 154170339, 649674624, 846766179, 692864663, 278533056], [986537894, 391498829, 248183898, 203191039, 852723420, 225833291, 1051951306, 970653690, 69285433, 597996285, 485364158, 172720692, 699057922, 969113471, 447213549, 566047293]]]
    evalkey_a_vector=[[[734218920, 197221402, 854318117, 986228800, 108529, 707493094, 812909578, 375805331], [650732066, 1027298157, 662696122, 401465389, 405295, 512627040, 880920842, 1053653230], [516000698, 900812937, 231622659, 980040895, 409265, 703596318, 78558225, 922254564], [579916780, 656621356, 553828467, 905795361, 413776, 1038061806, 621754645, 857556376], [7920082, 84006858, 779852006, 244824604, 124303, 869736935, 729842159, 136931996], [32761516, 1047724105, 118769478, 731305069, 154133, 351067745, 212069421, 1010452376], [225497728, 1000977809, 429330175, 994156648, 199895, 87295635, 687809561, 640561477], [961013627, 286657027, 392673617, 518983943, 218371, 242592634, 480711810, 704377559], [115427285, 923343325, 242344102, 810581306, 410498, 444626605, 352198351, 625272815], [195113464, 174381142, 768422378, 187468790, 135552, 742663976, 654118492, 351241524], [286512225, 655446789, 685351440, 993401735, 365024, 513817326, 48515866, 1041743755], [58938334, 168323159, 426278135, 662566142, 138038, 134608632, 590710448, 321269759], [1033724458, 98294504, 325385022, 302229790, 486533, 379411005, 339492598, 207662973], [871521589, 252340503, 424864945, 631475994, 490178, 123526745, 888688512, 2872375], [580300808, 591510793, 284578481, 943237178, 154144, 567208560, 682897126, 490129823], [11787885, 277185743, 692651121, 295162063, 384381, 782321364, 104222581, 361687360]], [[894065341, 1006486981, 148043121, 258107367, 156553, 19289500, 991149308, 724533203], [89774392, 960900859, 926981494, 465594730, 469045, 938850901, 114653871, 614724573], [305892083, 424433261, 590034393, 410460785, 281278, 94332291, 624010018, 335552676], [232833306, 288694108, 1041730198, 645114693, 220410, 465124834, 720857923, 508649083], [711233000, 185059023, 561310759, 509793199, 198805, 935256727, 197211530, 295935292], [700888821, 290049094, 431454132, 822472409, 46402, 204558865, 1037192045, 468102722], [602519146, 141159497, 359047234, 311222920, 361320, 287232241, 30564061, 56272416], [650307162, 553591983, 457138085, 856012649, 365508, 121770384, 1057642961, 606656416], [977208104, 104751608, 1060528971, 1033126780, 490794, 123005498, 421038173, 274826878], [206326587, 618448813, 398825354, 149903257, 442719, 516957129, 614181185, 271313756], [872910725, 804094075, 614254700, 676206371, 183272, 205667373, 276593996, 814856715], [927240999, 830549958, 103121442, 500715333, 337683, 655699100, 338717031, 883602419], [275947421, 262026845, 897179668, 785237459, 297641, 469013679, 1029259665, 401527403], [707640814, 240316290, 292229070, 903290367, 43162, 1026202714, 432850449, 483286344], [95769820, 802231114, 254152167, 572760204, 438395, 881077712, 855605393, 641925439], [238770927, 552298497, 407893357, 277287881, 450670, 776533058, 655539081, 10304102]], [[791532420, 750902324, 934035459, 922244581, 59001, 407888154, 579099926, 969908605], [580274372, 358624217, 436467844, 213316127, 77377, 506503532, 663247665, 977372064], [1053291536, 394107730, 536931500, 672706817, 130479, 651996211, 389811404, 646291342], [889979617, 481008155, 923450009, 978953864, 280375, 371584360, 865372211, 183128247], [947013163, 570544666, 788369343, 684620307, 476904, 184852515, 860655423, 190855122], [259021877, 991205523, 961680252, 1068130995, 128692, 925017916, 53866104, 708162236], [2536653, 335133840, 765155751, 388431616, 89107, 749237378, 514504172, 350741], [34799169, 393472320, 187194245, 582599644, 5893, 1010853477, 347925865, 911654890], [630707628, 29698807, 228245925, 642607092, 303710, 499410999, 987029450, 126030068], [732518219, 101868544, 446883384, 289853812, 68671, 136052115, 248503416, 669366774], [567758449, 535327538, 780616214, 521291354, 248722, 610714108, 629423180, 326735935], [625087010, 109393898, 1022980622, 47428208, 51599, 989985, 352522359, 122557403], [281029398, 748599852, 349161544, 395519255, 196726, 662102142, 1055689451, 954625720], [814507272, 1020219932, 712789647, 28407170, 123067, 493655356, 469358904, 959074473], [371345452, 734174056, 83612571, 437055135, 221970, 521553231, 476059814, 374847195], [452161025, 958681528, 10587242, 925934797, 222735, 725863646, 376714023, 932477594]]]
    evalkey_b_vector=[[[669533624, 166985809, 742452903, 166185952, 247219, 347755098, 445633766, 795906699], [390842113, 945043916, 331233429, 492328753, 62744, 1055250833, 139686159, 415307015], [201426783, 513490478, 62499025, 245232228, 239431, 89108012, 55741516, 385901201], [187745068, 749320943, 374537304, 417696034, 199557, 340653108, 62102509, 73167173], [294009980, 1026752625, 841399624, 917736540, 382363, 148611162, 24382989, 390509409], [828392867, 669643653, 407835448, 688058312, 387004, 198079524, 946903876, 50125079], [756134006, 108553208, 996425586, 25143411, 195313, 336858260, 813570860, 219615177], [1038434496, 141562804, 474977337, 173919628, 458132, 454501938, 571703789, 810219696], [882336581, 725142289, 739307102, 141006932, 212394, 394890707, 76200886, 519898348], [818603506, 745173722, 213023224, 290193025, 333864, 177976709, 1039415106, 272305968], [682947176, 149790684, 273924622, 1021217757, 262817, 846292398, 41645951, 766334632], [559085909, 288293640, 996081007, 991052310, 160129, 539941573, 722198480, 638773743], [37449012, 611702827, 957896947, 1067884971, 341073, 796918198, 525889200, 417835855], [560926447, 601274003, 265720372, 546079191, 249291, 719423180, 481310175, 883007637], [783461257, 214043787, 227573232, 439879093, 148497, 208876125, 909814758, 419455428], [165827564, 628509260, 569198674, 872238363, 302797, 406927799, 521352343, 874156874]], [[835073291, 405430014, 6644274, 178706285, 429464, 307128833, 921302083, 709141456], [10194301, 552069236, 106809348, 775433802, 443240, 907470224, 988480875, 1069379531], [904401591, 28937931, 210373481, 849458857, 358939, 146524279, 846468572, 841988054], [696719585, 527218566, 546859302, 550278845, 523219, 1024536540, 159252653, 24542858], [506481273, 173444173, 61791738, 288089680, 493287, 860567261, 387282544, 879463589], [75790854, 21473278, 816817389, 202325074, 451556, 991596274, 133661590, 895943414], [45347652, 535165295, 394089664, 597147057, 62580, 399036893, 950764239, 370717696], [308011568, 928722147, 364072949, 353070064, 152236, 42685480, 954107321, 336882597], [141615535, 644282694, 192092030, 432124224, 422370, 95704267, 626635186, 732990704], [94951755, 611550163, 639523910, 344539667, 492557, 517990488, 875840011, 285140786], [834671911, 881764167, 957705161, 337969821, 496634, 1032050054, 254777407, 597214476], [496231759, 87086285, 961352973, 467168335, 94234, 664253957, 280254059, 385680401], [549076858, 1016913066, 424435788, 958608025, 96231, 386370465, 680023409, 792262943], [387326982, 89595948, 965510062, 556128702, 472763, 97981880, 169830053, 669912873], [101809626, 964175944, 63271275, 381359208, 92159, 331886468, 354323642, 713986716], [992135793, 365510743, 550894903, 360333892, 296481, 912017559, 103303082, 665571498]], [[1031800990, 872928447, 128862391, 676186805, 229438, 749624776, 247385973, 424750644], [555423297, 440867316, 482841640, 888900084, 147409, 402735687, 90948488, 879906139], [414523562, 85060467, 422994535, 452659876, 201566, 606340815, 588848662, 134965530], [866059027, 704817341, 523397080, 89720613, 322493, 564025759, 181646141, 73074349], [156803626, 748165299, 436185426, 963207958, 75561, 30647559, 135810498, 30596914], [996019117, 306959836, 814298569, 36351331, 82861, 561437112, 1018342906, 274153850], [803761545, 887648624, 578548027, 106181268, 434537, 193273730, 502867931, 983743555], [660563440, 527680244, 580028929, 929261689, 130775, 462695623, 298057302, 101384944], [511695, 153670538, 256988737, 977717750, 254365, 41097179, 833386988, 1031993403], [199137818, 717355861, 850170691, 178576808, 252861, 567711611, 941334656, 878367911], [893937324, 839360054, 1012085464, 501015040, 231942, 117377678, 841663642, 1044094398], [618403154, 968130248, 349823020, 85311815, 420978, 625372838, 480582400, 1058570847], [432883382, 734162252, 85391467, 634583895, 82911, 615270044, 689962723, 715524734], [184143093, 75323376, 224554741, 745331659, 38489, 900270938, 952697204, 708282546], [940714362, 1000162740, 967535153, 178641554, 513390, 129042283, 501455727, 723846016], [6826367, 63905228, 405744546, 361651376, 505791, 770948774, 1027105078, 105084712]]]
    v1=[[123073826, 258309089, 510951284, 181408682, 446506268, 990074352, 654431728, 56473414, 659007393, 104399886, 364468777, 1019609706, 371989636, 858551242, 575563630, 341381254], [229048224, 986944570, 1059294775, 945940594, 894524492, 828772121, 1013380265, 484551285, 199331111, 551312484, 642520580, 754321267, 895073828, 326919746, 827649856, 97842012], [666257977, 149101131, 813739953, 518383821, 672352245, 853086670, 81587859, 540456108, 307956080, 216317667, 630273080, 992936055, 277757642, 360824878, 210209231, 224949690], [868140722, 281456495, 924015623, 73870874, 780141697, 822807012, 614074741, 1004202121, 129193319, 463031609, 642991268, 912267518, 763900629, 1013154816, 973324379, 470845747], [107834, 107061, 27263, 282195, 216295, 213826, 342803, 275782, 120297, 431322, 320911, 176176, 469035, 46202, 379422, 154047]]
    e1=[[[207412754, 444005862, 178550790, 440401025, 591339444, 225206265, 94179045, 304768700, 594340719, 385401534, 483308831, 976012304, 133452591, 817530406, 134452221, 432094731], [194284652, 30986887, 469750049, 388859706, 74526995, 399598576, 639452445, 551611693, 58884909, 243599517, 785237043, 44008104, 973679492, 97569726, 176425683, 240238064], [1045017580, 748955531, 395106299, 332543463, 650521877, 1048089291, 750017318, 927881184, 360547956, 904028000, 293603714, 451553854, 401120814, 368873244, 297711216, 688101564], [1032593937, 725579342, 716614333, 531368182, 326354940, 975544454, 8897826, 450862438, 68230730, 360099564, 694259663, 20811805, 24298199, 113148562, 69086617, 324700486], [164691, 237110, 518010, 184827, 70922, 105509, 406092, 176369, 510255, 123143, 102602, 245808, 165980, 255700, 154291, 249098]], [[278737435, 823882089, 120084369, 347993298, 159761560, 45727915, 467618154, 506716819, 368409501, 755559583, 573354618, 344080501, 594463861, 155839419, 385369309, 514858871], [538956432, 286943244, 163296632, 86470337, 206757792, 69858420, 875815494, 792601289, 204723175, 304349388, 446326790, 320795823, 202376385, 116150856, 33159812, 720131752], [746534064, 411870716, 287452183, 789017452, 725303844, 151264869, 851366516, 871508632, 945471274, 742736406, 682392629, 398663043, 850431295, 931442032, 527452813, 824506658], [452726931, 618299612, 889273387, 248174971, 509826345, 457204609, 269576914, 334354696, 134013668, 251862152, 930583936, 333803259, 31880610, 663064370, 134970120, 182835578], [405111, 433494, 115879, 116800, 181022, 284233, 182631, 456200, 378952, 483931, 316912, 337892, 687, 207854, 254324, 38918]]]
    ba1=[[[388949259, 558010927, 183272316, 270192891, 618976597, 685730018, 638760289, 587713155, 216270027, 111720994, 548741991, 78351771, 539521114, 502940613, 161519079, 545745378], [571280280, 886672863, 287646158, 58030585, 315811745, 565384510, 692805777, 1009725319, 742520159, 808368497, 1047138715, 820253491, 442854160, 626900178, 753606578, 776718421], [704737101, 1045117595, 169161202, 838055887, 889793595, 462309293, 966596332, 654260494, 345319319, 998103430, 704505399, 363070651, 133364521, 138054292, 597132080, 385371027], [899230080, 704794700, 421901005, 369489981, 519028351, 967659549, 1682876, 507878880, 559824299, 691839630, 503917165, 872301679, 957379131, 288689421, 4791749, 825622037], [78087, 343250, 208383, 210490, 17626, 57691, 100553, 61952, 259541, 295273, 425267, 242618, 202184, 513641, 387032, 512307]], [[295900420, 550706833, 582793153, 87474896, 895028747, 463714339, 823605388, 374124782, 902745599, 811392366, 184824328, 631131483, 331067012, 865792360, 528205727, 242124522], [888585287, 339679800, 792567978, 782750490, 440776376, 612172825, 666980822, 883750810, 787456117, 448783038, 750844540, 401665408, 162760104, 33257188, 616363185, 160364924], [266802238, 741216975, 997791682, 573628169, 42878287, 898173726, 552020555, 177944604, 70362876, 398700815, 401187945, 908007514, 265871994, 151185591, 933031528, 243997113], [10926386, 487634984, 67409320, 994701663, 437006462, 506272849, 641072054, 717659229, 774497673, 741976380, 195046475, 212853756, 408724829, 733134383, 415876566, 110540274], [486997, 381295, 413701, 220381, 311084, 207556, 60158, 218838, 509728, 335033, 220724, 279662, 392355, 173288, 238331, 416934]]]
    v2=[[913929968, 627808519, 523509690, 82237585, 923342408, 1066844205, 580850610, 650191420, 778134803, 314293551, 803313920, 251743488, 816802822, 99781207, 92614693, 64544159], [918976741, 1048883136, 1039172905, 214195381, 418889023, 210299303, 498526671, 1019770445, 126271570, 610007239, 1001845959, 409360674, 1031032596, 841738358, 63395586, 211318902], [842208296, 896171406, 1038174984, 444669637, 783156833, 195287562, 953407022, 215631465, 341494016, 532750064, 472441829, 800796973, 598260732, 890766109, 289989916, 368466125], [442426214, 217950076, 468582857, 1018524567, 268530473, 845705707, 190584841, 842662693, 180668360, 550302267, 111896399, 230874831, 885779081, 339037361, 334688767, 587978505], [275998, 470943, 64159, 237606, 311502, 95034, 475090, 167080, 126151, 177872, 40522, 179808, 488502, 437283, 198179, 449095]]
    e2=[[[368481290, 840067159, 945784487, 1065185940, 261165114, 331413886, 19609231, 330935536, 791826615, 219401534, 548977659, 491657232, 20890534, 981284479, 846441481, 526820823], [898060193, 229851768, 13961098, 100931725, 208229603, 824255941, 642393698, 704601175, 947869385, 136390151, 152897389, 877517344, 992117471, 182411171, 10161401, 594549486], [282551266, 344552660, 869528574, 911063283, 652371021, 580241613, 245047953, 404645803, 500698373, 35656858, 400554603, 349400012, 1046117893, 821864956, 945936691, 199699921], [815502713, 507950223, 120531576, 62502214, 1024505898, 53224361, 388685412, 205641235, 477515681, 330419949, 215235609, 400747902, 395241318, 928320314, 431475676, 84951013], [375424, 117997, 124840, 330882, 354559, 506552, 310807, 344780, 120603, 149494, 6026, 325901, 292145, 206632, 11421, 92360]], [[675139925, 319706784, 251274249, 54226335, 701240930, 82300532, 645556193, 359454846, 1030441970, 529856033, 1013910979, 1005952930, 1055725740, 114248927, 131831076, 619075615], [677728378, 870433030, 1053229889, 249431312, 377193810, 919174809, 644179188, 978400259, 451648478, 522459684, 646116790, 829540595, 438276018, 673812656, 199145298, 132914311], [736091767, 20666368, 666618107, 603429528, 729857831, 139475350, 144096898, 176024915, 219424165, 629067593, 714655339, 468622240, 339618466, 742463691, 473879229, 712198616], [961753051, 1008691157, 286660904, 478613497, 221516193, 179104573, 378460322, 737485824, 978746717, 1013533286, 477507095, 308613426, 21346583, 1006393165, 132443087, 399065992], [485148, 122203, 463655, 429574, 116115, 155628, 190079, 503471, 349622, 472936, 304309, 5260, 201026, 89956, 238778, 67080]]]
    ba2=[[[537254543, 159810643, 172322018, 254909216, 846647575, 395755197, 222490408, 822449602, 939495959, 566890426, 533530149, 226548537, 424678892, 79770854, 993411681, 279947009], [532325573, 1062578556, 632732606, 281698941, 120334362, 440695039, 920990419, 679810203, 258429652, 650646495, 56661044, 468745246, 179213044, 374879572, 593063786, 640970841], [451599139, 884289096, 472126141, 39821755, 960869175, 907861812, 153628221, 420380404, 439122855, 486481452, 418550465, 450614469, 321708491, 286725688, 583082767, 980726720], [960944296, 1062660836, 448626036, 274375733, 469224614, 698343089, 719775347, 323118627, 963623350, 865412585, 1066714349, 1044952875, 546872538, 922130213, 403950836, 273705518], [38063, 478011, 40436, 17097, 378456, 2512, 453379, 24269, 165722, 377465, 141805, 16729, 230052, 2805, 371279, 44668]], [[730946680, 936273529, 507277267, 9026198, 792094974, 841402372, 569778045, 91981322, 505565760, 135908093, 126349537, 514423805, 1042456347, 931264384, 47325489, 468128166], [735311652, 930399488, 364262847, 576634838, 111191812, 1055762547, 745977487, 24594159, 35763589, 144370502, 1038233550, 989712390, 209412576, 740960465, 986308466, 754826233], [90827265, 884173774, 365030758, 776327799, 873590051, 938760574, 976325192, 199535270, 903760287, 1049536260, 941671673, 39284765, 700951024, 502281774, 593939116, 112089747], [811462937, 128671037, 19846834, 834983155, 547858594, 430793280, 727523116, 239468555, 192511357, 944010049, 248279711, 703543584, 68209799, 750883617, 836891160, 711611819], [92024, 302732, 481350, 430447, 363165, 456035, 27117, 485893, 310962, 127460, 509964, 50643, 319200, 189054, 204840, 480689]]]

    # Ciphertext are using (degree, moduli) layout
    ptxt0=[[136867625, 992729062, 1062901950, 64309566, 48023], [448217487, 21710597, 452417311, 776229866, 220065], [459110530, 1072702960, 135576683, 13425321, 107178], [399986586, 819955793, 346580006, 305401790, 87720], [338761771, 467831082, 833645419, 435102310, 305645], [253416924, 808362513, 770044521, 509826858, 509546], [529757713, 1036319305, 429707580, 665276930, 22149], [922456207, 726996332, 105156242, 988523858, 10556], [56346712, 330072408, 553702770, 645102273, 136241], [322124327, 359500508, 1054902493, 1008698515, 420817], [822180619, 673061236, 208387012, 877663497, 188715], [843740957, 603132359, 321561487, 67265671, 102123], [410369751, 388650230, 1058737500, 1009707013, 347437], [448727365, 430265802, 497160630, 382861955, 371814], [276075424, 22743178, 297873459, 418401481, 384996], [309009688, 991696481, 143704361, 422137951, 407445]]
    ptxt1=[[382046512, 153299965, 48454537, 798742872, 101736], [240284357, 731821477, 504241058, 776636874, 285617], [41092377, 437848438, 899301697, 739206274, 408128], [307226488, 642796631, 686556470, 284143936, 52415], [671534607, 563248595, 288646113, 648066181, 489241], [1017445560, 60118911, 175678803, 822923829, 399715], [744587943, 1068328586, 301308733, 321790380, 310181], [84356999, 141659599, 158100860, 440328010, 312555], [950466494, 538583523, 783295773, 783749595, 186870], [952221329, 671404662, 749855261, 1052110652, 435866], [448681865, 195420188, 737336312, 455087190, 196193], [166555421, 427947318, 800730045, 1015902820, 168410], [296843323, 359473, 1048140417, 653580570, 317051], [51475542, 6542875, 537717750, 369769640, 143492], [412426420, 730788896, 658784910, 60723402, 120686], [209904449, 154332546, 967652126, 440914487, 266667]]
    ct0=[[[525816884, 490266621, 693897610, 963539646, 126110], [1006228414, 908383460, 423793465, 407282709, 38962], [642382846, 286606397, 304737885, 435326326, 315561], [670179477, 877986378, 110894452, 674891771, 298210], [957738368, 783642827, 649697573, 954130661, 323271], [939146942, 300004302, 158612373, 403744550, 42884], [94775121, 655382361, 322562471, 666959806, 122702], [436426481, 662978930, 759416736, 422660881, 72508], [272616739, 1072592567, 899022089, 131184715, 395782], [433845321, 94126284, 979264482, 626796288, 191737], [297179729, 646457230, 912892411, 307838805, 89629], [922092728, 349643129, 684632138, 939567350, 344741], [949890865, 831504390, 118360580, 893344287, 25268], [951667978, 1057165980, 635214922, 671551376, 361102], [437594503, 776349756, 895005539, 423193230, 247675], [854755066, 694672181, 529075388, 174018131, 395399]], [[295900420, 888585287, 266802238, 10926386, 486997], [550706833, 339679800, 741216975, 487634984, 381295], [582793153, 792567978, 997791682, 67409320, 413701], [87474896, 782750490, 573628169, 994701663, 220381], [895028747, 440776376, 42878287, 437006462, 311084], [463714339, 612172825, 898173726, 506272849, 207556], [823605388, 666980822, 552020555, 641072054, 60158], [374124782, 883750810, 177944604, 717659229, 218838], [902745599, 787456117, 70362876, 774497673, 509728], [811392366, 448783038, 398700815, 741976380, 335033], [184824328, 750844540, 401187945, 195046475, 220724], [631131483, 401665408, 908007514, 212853756, 279662], [331067012, 162760104, 265871994, 408724829, 392355], [865792360, 33257188, 151185591, 733134383, 173288], [528205727, 616363185, 933031528, 415876566, 238331], [242124522, 160364924, 243997113, 110540274, 416934]]]
    ct1=[[[919301055, 685625538, 500053676, 685945311, 139799], [400095000, 720657312, 314788713, 765555853, 239275], [213414395, 1070581044, 297686397, 114090453, 448564], [562135704, 924495572, 726378225, 558519669, 69512], [444439301, 683582957, 175773847, 43548938, 343344], [339457876, 500813950, 9799174, 447525061, 402227], [967078351, 915576284, 454936954, 1041565727, 239207], [906806601, 821469802, 578481264, 763446637, 336824], [816219572, 797013175, 148677187, 673631088, 352592], [445368874, 248308436, 162595272, 843781380, 288978], [982212014, 252081232, 82145336, 448059682, 337998], [393103958, 896692564, 177603073, 987113838, 185139], [721522215, 179572517, 296107467, 126711251, 22750], [131246396, 381422447, 824443438, 218157996, 146297], [332095220, 250109961, 168126236, 464674238, 491965], [489851458, 795303387, 874637405, 714620005, 311335]], [[730946680, 735311652, 90827265, 811462937, 92024], [936273529, 930399488, 884173774, 128671037, 302732], [507277267, 364262847, 365030758, 19846834, 481350], [9026198, 576634838, 776327799, 834983155, 430447], [792094974, 111191812, 873590051, 547858594, 363165], [841402372, 1055762547, 938760574, 430793280, 456035], [569778045, 745977487, 976325192, 727523116, 27117], [91981322, 24594159, 199535270, 239468555, 485893], [505565760, 35763589, 903760287, 192511357, 310962], [135908093, 144370502, 1049536260, 944010049, 127460], [126349537, 1038233550, 941671673, 248279711, 509964], [514423805, 989712390, 39284765, 703543584, 50643], [1042456347, 209412576, 700951024, 68209799, 319200], [931264384, 740960465, 502281774, 750883617, 189054], [47325489, 986308466, 593939116, 836891160, 204840], [468128166, 754826233, 112089747, 711611819, 480689]]]
    input_ciphertext = [[[[[525816884, 490266621, 693897610, 963539646, 126110], [1006228414, 908383460, 423793465, 407282709, 38962], [642382846, 286606397, 304737885, 435326326, 315561], [670179477, 877986378, 110894452, 674891771, 298210]], [[957738368, 783642827, 649697573, 954130661, 323271], [939146942, 300004302, 158612373, 403744550, 42884], [94775121, 655382361, 322562471, 666959806, 122702], [436426481, 662978930, 759416736, 422660881, 72508]], [[272616739, 1072592567, 899022089, 131184715, 395782], [433845321, 94126284, 979264482, 626796288, 191737], [297179729, 646457230, 912892411, 307838805, 89629], [922092728, 349643129, 684632138, 939567350, 344741]], [[949890865, 831504390, 118360580, 893344287, 25268], [951667978, 1057165980, 635214922, 671551376, 361102], [437594503, 776349756, 895005539, 423193230, 247675], [854755066, 694672181, 529075388, 174018131, 395399]]], [[[295900420, 888585287, 266802238, 10926386, 486997], [550706833, 339679800, 741216975, 487634984, 381295], [582793153, 792567978, 997791682, 67409320, 413701], [87474896, 782750490, 573628169, 994701663, 220381]], [[895028747, 440776376, 42878287, 437006462, 311084], [463714339, 612172825, 898173726, 506272849, 207556], [823605388, 666980822, 552020555, 641072054, 60158], [374124782, 883750810, 177944604, 717659229, 218838]], [[902745599, 787456117, 70362876, 774497673, 509728], [811392366, 448783038, 398700815, 741976380, 335033], [184824328, 750844540, 401187945, 195046475, 220724], [631131483, 401665408, 908007514, 212853756, 279662]], [[331067012, 162760104, 265871994, 408724829, 392355], [865792360, 33257188, 151185591, 733134383, 173288], [528205727, 616363185, 933031528, 415876566, 238331], [242124522, 160364924, 243997113, 110540274, 416934]]], [[[919301055, 685625538, 500053676, 685945311, 139799], [400095000, 720657312, 314788713, 765555853, 239275], [213414395, 1070581044, 297686397, 114090453, 448564], [562135704, 924495572, 726378225, 558519669, 69512]], [[444439301, 683582957, 175773847, 43548938, 343344], [339457876, 500813950, 9799174, 447525061, 402227], [967078351, 915576284, 454936954, 1041565727, 239207], [906806601, 821469802, 578481264, 763446637, 336824]], [[816219572, 797013175, 148677187, 673631088, 352592], [445368874, 248308436, 162595272, 843781380, 288978], [982212014, 252081232, 82145336, 448059682, 337998], [393103958, 896692564, 177603073, 987113838, 185139]], [[721522215, 179572517, 296107467, 126711251, 22750], [131246396, 381422447, 824443438, 218157996, 146297], [332095220, 250109961, 168126236, 464674238, 491965], [489851458, 795303387, 874637405, 714620005, 311335]]], [[[730946680, 735311652, 90827265, 811462937, 92024], [936273529, 930399488, 884173774, 128671037, 302732], [507277267, 364262847, 365030758, 19846834, 481350], [9026198, 576634838, 776327799, 834983155, 430447]], [[792094974, 111191812, 873590051, 547858594, 363165], [841402372, 1055762547, 938760574, 430793280, 456035], [569778045, 745977487, 976325192, 727523116, 27117], [91981322, 24594159, 199535270, 239468555, 485893]], [[505565760, 35763589, 903760287, 192511357, 310962], [135908093, 144370502, 1049536260, 944010049, 127460], [126349537, 1038233550, 941671673, 248279711, 509964], [514423805, 989712390, 39284765, 703543584, 50643]], [[1042456347, 209412576, 700951024, 68209799, 319200], [931264384, 740960465, 502281774, 750883617, 189054], [47325489, 986308466, 593939116, 836891160, 204840], [468128166, 754826233, 112089747, 711611819, 480689]]]]]
    encrypted_mult_result_ref = [[[[[332715755, 355801815, 286566349, 854778042], [338666314, 128684684, 474163009, 463132608], [603845149, 148015625, 954067389, 611314484], [784105588, 955665672, 1071736797, 514637109]], [[176025798, 749147497, 226344544, 377311610], [306116189, 443278677, 416219582, 803035605], [929514039, 97883944, 347065130, 42410372], [1053509648, 44546896, 961110380, 399633456]], [[80483914, 65156906, 611546191, 588262520], [1049667370, 690317853, 741783176, 122021404], [992381727, 303366157, 580364617, 353587735], [1020087586, 681128980, 946223867, 804233341]], [[584218867, 239180041, 356990773, 657837525], [789145683, 448045124, 588530763, 1053748601], [274128201, 591931770, 211374449, 613071633], [238587385, 820419123, 352673945, 30113283]]], [[[428441940, 1007683256, 689086831, 1014008988], [194419121, 784944716, 706537138, 845266843], [427282618, 177929180, 419067880, 1045571141], [121769733, 965244976, 841225907, 897940610]], [[972523406, 21221783, 527479530, 727274435], [173840928, 981613188, 825459723, 958498610], [536082298, 842016832, 257577784, 140811965], [623158848, 748696252, 533660475, 653171405]], [[27983002, 242758282, 100182769, 448616177], [782002374, 643072171, 511438526, 536869054], [607180938, 122688886, 855196380, 105946283], [1024950667, 431223999, 147601509, 734419167]], [[668480124, 786487360, 644853291, 579737469], [928118232, 645779225, 502010738, 423589878], [931945088, 800473185, 392262045, 551151491], [50823892, 364358313, 17996839, 1067174686]]]]]
    decrypted_result_ref = [[617341056, 616774356, 615696756, 615373056], [870497407, 825262851, 463340323, 1010470873], [1051719038, 910828504, 857146153, 794120965], [686503437, 394122650, 202409476, 747929858], [304716178, 304715858, 304713298, 304714130], [948358831, 21286690, 120680769, 813198094], [271914180, 82830489, 717770563, 565077983], [425687745, 80858165, 543215448, 366151555], [1024551164, 1024551324, 1024552604, 1024552188], [60849608, 405678388, 1017056146, 120380678], [225684628, 414766559, 853553846, 1006251418], [429702734, 283031834, 183636475, 564861423], [941971831, 941971991, 941973271, 941972855], [956907058, 175544644, 367255258, 895477565], [601850813, 742740707, 796417938, 859444790], [632571836, 677806392, 1039728920, 492598370]]

    # Testing Parameters
    r, c = 4, 4
    assert (r*c==self.degree)
    batch, num_elements, dnum, num_eval_mult = 1, 2, 3, 1
    eval_key_a, eval_key_b = jnp.array(evalkey_a_vector, dtype=jnp.uint32), jnp.array(evalkey_b_vector, dtype=jnp.uint32)
    params = self.params.copy()
    params.update({
        "secret_key": secret_key,
        "public_key": public_key,
        "evaluation_key": [eval_key_a, eval_key_b],
    })

    # Class Initialization
    ctx = ckks_ctx.CKKSContext(params)
    he_mul = HEMul(batch, r, c, dnum, num_eval_mult, self.q_towers, self.p_towers)
    he_mul.control_gen(degree_layout=(r,c))
    he_mul.setup_relinearization(eval_key_a, eval_key_b)

    # Logics
    # Step 1: Encoding
    encoded_ct1 = ctx.encode(self.real_values_input_in1)
    encoded_ct2 = ctx.encode(self.real_values_input_in2)
    if debug:
      np.testing.assert_array_equal(encoded_ct1.ciphertext[0,0], ptxt0)
      np.testing.assert_array_equal(encoded_ct2.ciphertext[0,0], ptxt1)
    # Step 2: Encryption
    if debug:
      encrypted_ct1 = ctx.encrypt(encoded_ct1, v=v1, e=e1, ba=ba1)
      encrypted_ct2 = ctx.encrypt(encoded_ct2, v=v2, e=e2, ba=ba2)
      np.testing.assert_array_equal(encrypted_ct1.ciphertext[0], ct0)
      np.testing.assert_array_equal(encrypted_ct2.ciphertext[0], ct1)
    else:
      encrypted_ct1 = ctx.encrypt(encoded_ct1)
      encrypted_ct2 = ctx.encrypt(encoded_ct2)
    # Step 3: Multiplication
    in_cts = jnp.concatenate([encrypted_ct1.ciphertext, encrypted_ct2.ciphertext], axis=1).reshape(batch, 2*num_elements, r, c, len(self.q_towers)).astype(jnp.uint32)
    if debug:
      np.testing.assert_array_equal(input_ciphertext, in_cts)
    encrypted_result = he_mul.mul(in_cts)
    if debug:
      np.testing.assert_array_equal(encrypted_result, encrypted_mult_result_ref)
    # Step 4: Decryption
    encrypted_result = encrypted_result.reshape(batch, 2, self.degree, len(self.q_towers)-1)
    encrypted_ct1.drop_last_modulus()
    encrypted_ct1.set_batch_ciphertext(encrypted_result)
    decrypted_result = ctx.decrypt(encrypted_ct1)
    if debug:
      np.testing.assert_array_equal(decrypted_result.ciphertext[0,0], decrypted_result_ref)
    # Step 5: Decoding
    decoded_values = ctx.decode(decrypted_result, is_ntt=False)
    if debug:
      np.testing.assert_array_almost_equal(decoded_values, self.real_values_multiply_result, decimal=3)

if __name__ == "__main__":
  absltest.main()
